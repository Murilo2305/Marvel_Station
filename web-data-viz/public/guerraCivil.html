<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Marvel Station</title>

  <script src="./js/sessao.js"></script>

  <link rel="stylesheet" href="./css/MarvelStation.css">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

  <header>

    <nav>

      <div class="part1">

        <div>

          <img class="logo" src="./../public/assets/MarvelStation_Logo.png">

        </div>

        <ul>

          <li>

            <a href="index.html">Pagina Principal</a>

          </li>

          <li>

            <a href="sobreMim.html">Sobre o criador</a>

          </li>

          <li>

            <a class="active" href="guerraCivil.html">Discussões</a>

          </li>

        </ul>

      </div>

      <div class="part2">

        <img src="../public/assets/user_icon.png" alt=>

        <b id="b_usuario"></b>

        <button id="button_login"></button>


      </div>

    </nav>

  </header>

  <main>

    <div class="container-discucoes">



      <input type="number" id="input_voto"><br>
      <button onclick="Votar()">Votar</button><br>

      <canvas id="canvas_resultadoVotacao"></canvas><br>

      <span id="span_tamanho">0/1000</span><br>
      <textarea oninput="MostrarTamanho()" maxlength="1000" id="textarea_comentario"></textarea><br>
      <button onclick="Comentar()">Comentar</button>

      <div class="comentarios" id="div_comentarios">

        <div class="box-comentario">

          <div class="usuario">

            <img src="../public/assets/user_icon.png" alt="">
            <h1>usuario</h1>

          </div>

          <span></span>

        </div>

      </div>

    </div>

    <div class="lista-discucoes">

      <h3>Todas as Discussões</h3>

      <ul>

        <li><a href="guerraCivil.html">Quem estava certo na guerra civil?</a></li>

      </ul>

    </div>

  </main>

  <footer>

    <span>Email de contato: marvel.station@gmail.com</span>

  </footer>

</body>

</html>

<script>

  var chartVotacao;

  var b_usuario = document.getElementById("b_usuario");
  var button_login = document.getElementById('button_login');

  if (sessionStorage.NOME_USUARIO != undefined && sessionStorage.NOME_USUARIO != 'undefined') {

    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
    button_login.innerHTML = 'Sair';
    button_login.onclick = Sair;


  } else {

    b_usuario.innerHTML = 'Visitante';
    button_login.innerHTML = 'Loginnnn';
    button_login.onclick = Login;

  }

  function Sair() {

    sessionStorage.clear();
    window.location.reload();


  }

  function Login() {

    window.location.href = 'login.html';

  }

  function MostrarTamanho() {

    var textarea = textarea_comentario.value;
    span_tamanho.innerHTML = `${textarea.length}/1000`;

  }

  function Comentar() {

    if (sessionStorage.NOME_USUARIO == undefined || sessionStorage.NOME_USUARIO == '') {

      alert('Você precisa estar logado para poder comentar');

    } else {


      fetch('/comentario/comentar', {

        method: 'POST',
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({

          texto: textarea_comentario.value,
          idUsuario: sessionStorage.ID_USUARIO,
          idDiscucao: 1,

        }),

      })
        .then(function (resposta) {

          if (resposta.ok) {

            alert('Comentário realizado com sucesso!')
            exibirComentarios();

          } else {

            alert('Erro ao comentar')

          }

        })
    }

  }

  function exibirComentarios() {

    fetch(('comentario/exibirComentarios'), {

      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({

        idDiscucao: 1

      }),

    })
      .then(function (resposta) {

        resposta.json().then(function (response) {

          response.reverse();
          console.log(JSON.stringify(response));

          var msg = '';

          for (var x = 0; x < response.length; x++) {

            msg += `
          
            <div class="box-comentario">

              <div class="usuario">

                <img src="../public/assets/user_icon.png" alt=""> 
                <h1>${response[x].nome}</h1>

              </div>

              <span>${response[x].texto}</span>

            </div>
            `

          }

          div_comentarios.innerHTML = msg;

        })

      })

  }

  function Votar() {


    fetch('/votacao/votar', {

      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({

        voto: input_voto.value,
        idUsuario: sessionStorage.ID_USUARIO,
        idDiscucao: 1,

      }),

    })
      .then(function (resposta) {

        if (resposta.ok) {

          alert('Voto efetuado com sucesso!');
          AtualizarGrafico(chartVotacao.data);

        } else {

          alert('Erro na votação');

        }

      })
      .catch(function (resposta) {
        console.log(`#ERRO: ${resposta}`);

      });

    return false;

  }

  function gerarGrafico() {

    fetch(('votacao/gerarGrafico'), {

      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({

        idDiscucao: 1

      }),

    })
      .then(function (resposta) {

        resposta.json().then(function (response) {

          response.reverse();
          console.log(`Dados recebidos: ${JSON.stringify(response)}`);

          let labels = [

            'Votos'

          ];

          let dados = {

            labels: labels,
            datasets: [{
              label: 'Capitão América',
              data: [],
              fill: false,
              borderColor: '#0000ff',
              backgroundColor: '#002d5c',
              tension: 0.1
            },
            {
              label: 'Homem de Ferro',
              data: [],
              fill: false,
              borderColor: '#E30022',
              backgroundColor: '#CC0000',
              tension: 0.1
            }]

          }

          if (response.length > 1) {

            dados.datasets[0].data.push(response[0].total);
            dados.datasets[1].data.push(response[1].total);

          } else if (response.length == 1 && response[0].Opcao == 1) {

            dados.datasets[0].data.push(response[0].total);

          } else if (response.length == 1 && response[0].Opcao == 2) {

            dados.datasets[1].data.push(response[0].total);

          } else {

            dados.datasets[0].data.push(0);
            dados.datasets[1].data.push(0);

          }



          const config = {
            type: 'bar',
            data: dados,
            options: {

              scales: {

                x: {

                  ticks: {

                    color: 'black'

                  }

                },
                y: {

                  ticks: {

                    color: 'black'

                  }

                }

              }

            }
          };

          chartVotacao = new Chart(
            document.getElementById(`canvas_resultadoVotacao`),
            config
          );

        })



      })

  }

  function AtualizarGrafico(dados) {

    fetch(('votacao/gerarGrafico'), {

      method: 'POST',
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({

        idDiscucao: 1

      }),

    })
      .then(function (resposta) {

        resposta.json().then(function (response) {

          response.reverse();
          console.log(`Dados recebidos: ${JSON.stringify(response)}`);



          dados.datasets[0].data.shift();
          dados.datasets[1].data.shift();

          if (response.length > 1) {

            dados.datasets[0].data.push(response[0].total);
            dados.datasets[1].data.push(response[1].total);

          } else if (response.length == 1 && response[0].Opcao == 1) {

            dados.datasets[0].data.push(response[0].total);

          } else if (response.length == 1 && response[0].Opcao == 2) {

            dados.datasets[1].data.push(response[0].total);

          } else {

            dados.datasets[0].data.push(0);
            dados.datasets[1].data.push(0);

          }

          chartVotacao.update();

        })

      })

  }

  gerarGrafico();
  exibirComentarios();

</script>